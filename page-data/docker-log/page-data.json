{"componentChunkName":"component---src-pages-blog-post-js","path":"/docker-log/","result":{"data":{"site":{"siteMetadata":{"title":"klloo"}},"markdownRemark":{"id":"7e160f21-8d7a-5522-9b38-448093b8a335","excerpt":"…","html":"<h3>문제 상황</h3>\n<p>제가 친구들과 운영하고 있는 웹 사이트가 하나 있는데요 ... 이 웹사이트는 제 친구들이 함께 사용하고 있습니다. 그런데 오늘 ...</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 444px; overflow: hidden!important; border-radius: 8px!important; margin-left: 0!important;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/17588963d1f23862ad9d6871125bdf66/9b7bd/kakao.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.56521739130434%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACQUlEQVR42o1US2taURC+vyEqPogaH9dWqaC5Vk0Ltaah2kAJdaEW68aYFIpF2u7cR/Insk5+hzsRN/kB8YG48HV9rVTy9c4kEYxWeuBj7syZM2fmzjdH2Nvbg8VigdFohNVqhdlshslkgmi3QrRZHmFlOEQ7++l0Ouj1+o0QnE4nEokETk9PEYlEkEql8C2dRvDdEQ4OjxE8OsFBOIrg+094G/rAQSmgwWBYAwekrOLxOHK5HKLRKDKZDH79/oP9j18hnfyA9OUnpM9njED4GBazESqVChqNZg1arRaC3W6Hx+OB2+2GJEn87VXg8/nge61A2lfsPgbZXC4X6IwoiitwOByg3ycUCgXMZjN0Oh1Gr9dDt9uFLA/Q7/cxlGUMh8NHKWM0GmE8HjMmkwmD9mldXV1BuLy85M1SqYRyuYxms4nb21tUq1VUKpWl8/39Pf61FosFy5ubGwjFYpEzrNVquLu7Q6vVQr1eZ0l6o9FgnSTZ2u02X0pVPF00n8/5+/r6GsLFxQUrlAmVS6DSp9Mp26hs0mWl5MFgwCWTD+kUbGtAAv0TCvbk9D9rpWRqCh2mWykDgvzYCMpmNBovm/AcG5tCLSc6MF283iUeKPJSocMqNZ7TZY02RGyajnw+j7QyId/Pz3lqAoE3kLxGvHBosbPzQFy1Ws3YROolsW02G5LJJLLZLGKxGBLxBI+i3+9XyP4Kh4dhJjVlHQqFQP5bR48eAhp4MpDc3d1laVHSNykPBQWgB4MqodJof9vj8BduPK8rGEteYAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kakao\"\n        title=\"\"\n        src=\"/static/17588963d1f23862ad9d6871125bdf66/9b7bd/kakao.png\"\n        srcset=\"/static/17588963d1f23862ad9d6871125bdf66/948cf/kakao.png 138w,\n/static/17588963d1f23862ad9d6871125bdf66/6b2ea/kakao.png 275w,\n/static/17588963d1f23862ad9d6871125bdf66/9b7bd/kakao.png 444w\"\n        sizes=\"(max-width: 444px) 100vw, 444px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>갑자기 접속이 안된다는 이슈를 다소 원시적인 수단으로 전달받았습니다.</p>\n<p>그래서 접속을 해봤는데 아니 캡쳐를 못했어요<br/>\n아무튼 빈화면에 개발자도구에는 <code class=\"language-text\">net::ERR_CONTENT_LENGTH_MISMATCH</code>이 에러메시지만 달랑 남겨져있었습니다.</p>\n<p>그래서 구글링을 해보니 서버의 디스크 용량이 꽉차서 그랬다는 얘기가 있길래 저도 확인해봤는데 해당 서비스를 배포한 제 프리티어 EC2의 루트 디렉토리가 꽉차있더라구요 (이것도 캡쳐 못함ㅠ)</p>\n<h3>해결</h3>\n<p>그래서 <code class=\"language-text\">du -h --max-depth=1</code> 명령어를 통해 하나씩 타고 들어가며 용량을 확인해줬습니다. 해당 명령어는 disk usage의 약자로 파일 및 디렉토리의 용량을 확인해주는 명령어입니다.</p>\n<p>어 그런데 루트 디렉토리 하위 경로에 접근하려면 대부분 권한이 필요했어서...루트 계정으로 로그인 후 진행을 해줬습니다.</p>\n<p>그렇게 타고 타고 들어가보니 /var/lib/docker/container 위치에 무언가 20G나 공간을 차지하고 있었습니다. 이 디렉토리는 컨테이너의 로그가 쌓이는 디렉토리였는데요, 해당 디렉토리에는 이렇게 컨테이너별 로그가 json의 형식으로 저장되어 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 550px; overflow: hidden!important; border-radius: 8px!important; margin-left: 0!important;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a19260962dffcc4438f03041e88c4946/229ad/log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.318840579710146%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAjElEQVR42h2LyQ6CMBiEeRPRk0Shi1RbJVEjQitoonioorjE93+F8Q+HL7NkJhglGQYTjZAYsgzh1PQ5MhYL20LlVxjrMSdVuwba3qBLD+3uENsG8aoG21zA1meM6RvIvYc6fqFOP6TVB2lNVG/MqBPkuXshyT1Y0YKXj16ZfYITkvbSdZCHDoKI4iX+njRGgwphR9AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"log\"\n        title=\"\"\n        src=\"/static/a19260962dffcc4438f03041e88c4946/dd45a/log.png\"\n        srcset=\"/static/a19260962dffcc4438f03041e88c4946/948cf/log.png 138w,\n/static/a19260962dffcc4438f03041e88c4946/6b2ea/log.png 275w,\n/static/a19260962dffcc4438f03041e88c4946/dd45a/log.png 550w,\n/static/a19260962dffcc4438f03041e88c4946/d4c13/log.png 825w,\n/static/a19260962dffcc4438f03041e88c4946/99f37/log.png 1100w,\n/static/a19260962dffcc4438f03041e88c4946/229ad/log.png 1356w\"\n        sizes=\"(max-width: 550px) 100vw, 550px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>이렇게 컨테이너 별 디렉토리가 있고 해당 폴더 안에는 [해당 폴더명]-json.log라는 파일이 있습니다. 폴더명의 앞글자는 컨테이너 ID인데 이것과 대조해서 살펴보니 백엔드 서버 역할을 하는 컨테이너의 로그 파일이 굉장히 컸던 것을 확인할 수 있었습니다. (이 모든 과정을 캡쳐하지 못함ㅠ_ㅠ)</p>\n<p>그래서 해당 파일을 <code class=\"language-text\">truncate -s 0 [파일명]</code> 명령어를 통해 한 번 정리해줬더니</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 550px; overflow: hidden!important; border-radius: 8px!important; margin-left: 0!important;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3ae96959e3988871e0deb88cf7d47e7e/c6ff8/result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.521739130434782%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAARElEQVR42mOwtnX/7+zq/9/c0uW/pbXrf119q//qmqb/NbTMMDBIXM/A+r+1rcd/Kxs3IHb/b+fg9d/ewfu/hZULWB4AGAkg16LErCEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result\"\n        title=\"\"\n        src=\"/static/3ae96959e3988871e0deb88cf7d47e7e/dd45a/result.png\"\n        srcset=\"/static/3ae96959e3988871e0deb88cf7d47e7e/948cf/result.png 138w,\n/static/3ae96959e3988871e0deb88cf7d47e7e/6b2ea/result.png 275w,\n/static/3ae96959e3988871e0deb88cf7d47e7e/dd45a/result.png 550w,\n/static/3ae96959e3988871e0deb88cf7d47e7e/d4c13/result.png 825w,\n/static/3ae96959e3988871e0deb88cf7d47e7e/c6ff8/result.png 1088w\"\n        sizes=\"(max-width: 550px) 100vw, 550px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>용량이 널널해진 것을 확인할 수 있었습니다! 이 후 컨테이너를 다시 올렸더니 사이트 접속도 잘 되었습니다.</p>\n<p>앞으로도 이렇게 주기적으로 로그파일을 정리해줄 수도 있지만 찾아보니 로그 파일의 사이즈를 제한해주는 방법도 있었습니다.</p>\n<p>docker-compose.yml 파일에 다음과 같이 로깅 옵션을 추가해주면 된다고 합니다!</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">  <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"json-file\"</span>\n      <span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">max-size</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1G\"</span>\n        <span class=\"token key atrule\">max-file</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span></code></pre></div>\n<p>1G이하의 로그파일을 최대 1개까지만 생성해주도록 설정을 했는데요...설정 후 컨테이너를 다시 띄웠는데 제대로 적용이 됐는지는 아직 모르겠습니다ㅎㅠ</p>\n<p>그리고 궁금해서 찾아보니 로깅 드라이버의 종류도 되게 많더라구요 <a href=\"https://docs.docker.com/config/containers/logging/configure/#supported-logging-drivers\">여기</a>서 확인할 수 있고요. 저는 사실.. <code class=\"language-text\">none</code>말고는 다 잘 모르겠어서. 그냥 기본 값인 <code class=\"language-text\">json-file</code>을 사용해줬습니다.</p>\n<p>사용자 수가 적은 서비스라... 서버에 잘 올려놓기만하면 끝인 줄 알았는데 생각보다 크고 작은 문제들이 많이 발생하고 있는 것 같습니다. 사용자 수가 아무리 적더라도 안정적으로 서비스를 운영한다는 것은 생각보다 어려운 일 같습니다...</p>","tableOfContents":"<ul>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9\">문제 상황</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0\">해결</a></li>\n</ul>","frontmatter":{"title":"EC2에서 Docker Container 로그 정리하기","date":"January 28, 2024","description":"어쩌구","category":"Project","icon":"🧹","tags":["Docker","AWS","Project"]}},"previous":{"fields":{"slug":"/nginx-request-error/"},"frontmatter":{"title":"Nginx 413 Request Entity Too Large 에러 해결"}},"next":null},"pageContext":{"id":"7e160f21-8d7a-5522-9b38-448093b8a335","previousPostId":"2351dbbd-b74d-502e-99d1-1ad4c166d677","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}